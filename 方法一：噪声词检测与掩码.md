📋 实施方案 - 分步骤进行
---
第一步：创建噪声检测数据集类
文件：bases.py
任务：新增一个数据集类，支持加载干净文本和噪声文本对
具体修改：
```
# 在 ImageTextMLMDataset 类后面添加新类

class ImageTextNoiseDetectionDataset(Dataset):
    """
    图文数据集类（用于噪声检测训练）
    返回：图像 + 干净文本 + 噪声文本 + 噪声标签
    """
```
需要实现的功能：
1. 加载图像
2. 加载干净caption和噪声caption（从JSON文件中）
3. 对比两个caption生成噪声标签（0/1数组）
4. 生成属性词mask（只在属性词位置计算loss）
---
第二步：添加噪声检测损失函数
文件：objectives.py

任务：新增噪声检测的损失函数

具体修改：

```
# 在文件末尾添加

def compute_noise_detection(noise_logits, noise_labels, attribute_mask):
    """
    噪声检测二分类损失
    Args:
        noise_logits: (B, L, 2) - 每个token的分类logits
        noise_labels: (B, L) - 0=干净, 1=噪声
        attribute_mask: (B, L) - 1=属性词位置, 0=其他词
    """
```
---
第三步：修改IRRA模型架构
文件：build.py

任务：

保留cross-modal transformer
移除MLM head
新增噪声检测head
修改forward逻辑
具体修改位置：

在__init__中：注释掉mlm_head，添加noise_detection_head
在forward中：修改返回的特征和损失
---
第四步：修改训练配置
文件：options.py

任务：添加新的命令行参数

具体修改：

```
# 添加噪声检测相关参数
parser.add_argument("--noise_detection", default=False, action='store_true')
parser.add_argument("--noise_loss_weight", type=float, default=1.0)
parser.add_argument("--noisy_train_json", default="", help="path to noisy training json")
```
---
第五步：修改数据加载器
文件：build.py

任务：根据是否使用噪声检测，选择不同的数据集类

具体修改：在build_dataloader函数中添加条件分支

---
第六步：修改训练流程
文件：processor.py

任务：在训练循环中添加噪声检测损失的计算
---
第七步：实现测试时的噪声掩码
文件：新建 processor/noise_masking.py

任务：实现测试时的噪声检测和掩码逻辑

---
第八步：修改测试脚本
文件：test.py

任务：调用噪声掩码功能进行推理